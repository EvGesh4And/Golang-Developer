# 12. Соглашение по утилитам

## 12.1 Синтаксис аргументов утилит

Этот раздел описывает синтаксис аргументов стандартных утилит и вводит терминологию, используемую в POSIX.1-2017 для описания аргументов, обрабатываемых утилитами.

В POSIX.1-2017 используется специальная нотация для описания синтаксиса аргументов утилиты. Если не указано иное, все описания утилит используют эту нотацию, которая иллюстрируется следующим примером (см. XCU Simple Commands):

```
utility_name [-a] [-b] [-c option_argument] [-d|-e] [-f[option_argument]] [operand...]
```

Нотация, используемая в разделах SYNOPSIS, накладывает требования на реализаторов стандартных утилит и предоставляет простую справку для разработчиков приложений или пользователей системы.

1. Утилита в примере называется `utility_name`. За ней следуют опции, аргументы опций и операнды. Аргументы, состоящие из символов `<hyphen-minus>` и одиночных букв или цифр, таких как `'a'`, известны как "опции" (или, исторически, "флаги"). Некоторые опции сопровождаются "аргументом опции", как показано с `[-c option_argument]`. Аргументы, следующие за последними опциями и аргументами опций, называются "операндами".

2. Аргументы опций показаны отделенными от своих опций пробелами, за исключением случаев, когда аргумент опции заключен в скобки `'['` и `']'`, чтобы указать, что он необязателен. Это отражает ситуацию, в которой необязательный аргумент опции (если присутствует) включается в ту же строку аргумента, что и опция; для обязательного аргумента опции он является следующим аргументом. Руководство по синтаксису утилит в Utility Syntax Guidelines требует, чтобы опция была отдельным аргументом от своего аргумента опции и чтобы аргументы опций не были необязательными, но в POSIX.1-2017 есть некоторые исключения для обеспечения продолжения работы исторических приложений:

   1. Если в SYNOPSIS стандартной утилиты показана опция с обязательным аргументом опции (как с `[-c option_argument]` в примере), соответствующее приложение должно использовать отдельные аргументы для этой опции и ее аргумента опции. Однако соответствующая реализация также должна разрешать приложениям указывать опцию и аргумент опции в одной строке аргумента без промежуточных пробелов.

   2. Если в SYNOPSIS показан необязательный аргумент опции (как с `[-f[ option_argument]]` в примере), соответствующее приложение должно помещать любой аргумент опции для этой опции непосредственно рядом с опцией в той же строке аргумента, без промежуточных пробелов. Если утилита получает аргумент, содержащий только опцию, она должна вести себя, как указано в ее описании для отсутствующего аргумента опции; она не должна рассматривать следующий аргумент (если таковой имеется) как аргумент опции для этой опции.

3. Опции обычно перечислены в алфавитном порядке, если только это не делает описание утилиты более запутанным. Нет подразумеваемых отношений между опциями на основе порядка их появления, если не указано иное в разделе OPTIONS или если не применяется исключение в Руководстве 11 из Utility Syntax Guidelines. Если опция, не имеющая аргументов опции, повторяется, результаты не определены, если не указано иное.

4. Часто имена параметров, требующих замены фактическими значениями, показаны с встроенными символами подчеркивания. Альтернативно, параметры показаны следующим образом:

```
<имя параметра>
```

Угловые скобки используются для символической группировки фразы, представляющей один параметр, и соответствующие приложения не должны включать их в данные, передаваемые утилите.

5. Когда утилита имеет только несколько допустимых опций, они иногда показаны индивидуально, как в примере. Утилиты с множеством флагов обычно показывают все отдельные флаги (которые не принимают аргументы опций) сгруппированными, как в:

```
utility_name [-abcDxyz] [-p arg] [operand]
```

Утилиты с очень сложными аргументами могут быть показаны следующим образом:

```
utility_name [options] [operands]
```

6. Если не указано иное, когда операнд или аргумент-опция является числовым значением или содержит его:

- Число интерпретируется как десятичное целое число.
- Числа в диапазоне от 0 до 2147483647 синтаксически распознаются как числовые значения.
- Когда в описании утилиты указано, что она принимает отрицательные числа в качестве операндов или аргументов-опций, числа в диапазоне от -2147483647 до 2147483647 синтаксически распознаются как числовые значения.
- Когда в описании утилиты указано, что число является значением, связанным с размером файла (например, размер файла или смещение, номер строки или количество блоков), числа в диапазоне от 0 до максимального размера файла, поддерживаемого реализацией, синтаксически распознаются как числовые значения (см. XCU "Учитывая утилиты в поддержку файлов произвольного размера"). Когда допускаются отрицательные значения, любые значения в диапазоне от -(максимальный размер файла) до максимального размера файла принимаются.
- Диапазоны, превышающие указанные здесь, разрешены.

Это не означает, что все числа в пределах допустимого диапазона обязательно семантически корректны. Стандартная утилита, которая принимает аргумент-опцию или операнд, который должен быть интерпретирован как число, и для которого диапазон значений меньше указанного выше разрешен по стандарту POSIX.1-2017, описывает этот меньший диапазон вместе с описанием аргумента-опции или операнда. Если возникает ошибка, диагностическое сообщение утилиты должно указывать, что значение выходит за пределы поддерживаемого диапазона, а не что оно синтаксически некорректно.

7. Аргументы или аргументы-опции, заключенные в квадратные скобки '[' и ']', являются необязательными и могут быть опущены. Соответствующие приложения не должны включать символы '[' и ']' в данные, передаваемые утилите.

8. Аргументы, разделенные символом '|' (вертикальная черта), являются взаимоисключающими. Соответствующие приложения не должны включать символ '|' в данные, передаваемые утилите. В качестве альтернативы, взаимоисключающие опции и операнды могут быть перечислены с несколькими строками синопсиса.

Пример:

```
utility_name -d[-a][-c option_argument][operand...]
utility_name[-a][-b][operand...]
```

Когда для утилиты приводится несколько строк синопсиса, это указывает на то, что утилита имеет взаимоисключающие аргументы. Эти взаимоисключающие аргументы изменяют функциональность утилиты так, что только определенные другие аргументы могут быть действительны в сочетании с одним из взаимоисключающих аргументов. Для вызова утилиты разрешается только один из взаимоисключающих аргументов. Если в соответствующем разделе OPTIONS не указано иное, отношения между аргументами, изображенные в разделах SYNOPSIS, являются обязательными требованиями для соответствующих приложений. Использование конфликтующих взаимоисключающих аргументов приводит к неопределенным результатам, если в описании утилиты не указано иное. Когда опция показана без квадратных скобок '[' и ']', это означает, что эта опция обязательна для данной версии SYNOPSIS. Однако она не обязана быть первым аргументом, как показано в примере выше, если не указано иное.

9. Многоточие ("...") используется для обозначения того, что разрешено одно или несколько повторений операнда. Когда опция или операнд с многоточием заключены в квадратные скобки, можно указать ноль или более опций или операндов. Формат:

```
utility_name [-g option_argument]...[operand...]
```

указывает на то, что несколько повторений опции и её аргумента-опции перед многоточием действительны, с семантикой, указанной в разделе OPTIONS утилиты. (См. также Руководство 11 в Руководстве по синтаксису утилит.)

Формат:

```
utility_name -f option_argument [-f option_argument]... [operand...]
```

указывает на то, что опция -f должна появляться хотя бы один раз и может появляться несколько раз.

10. Когда строка синопсиса слишком длинная, чтобы быть напечатанной в одну строку в разделе Shell and Utilities объема POSIX.1-2017, строки с отступом, следующие за начальной строкой, являются строками продолжения. Реальное использование команды будет отображаться на одной логической строке.

## 12.2 Руководство по синтаксису утилит
Следующие рекомендации установлены для именования утилит и для спецификации опций, аргументов-опций и операндов. Функция getopt() из объема System Interfaces POSIX.1-2017 помогает утилитам обрабатывать опции и операнды, соответствующие этим рекомендациям.

Операнды и аргументы-опции могут содержать символы, не указанные в переносимом наборе символов.

Рекомендации предназначены для того, чтобы дать указания авторам будущих утилит, например, тех, что написаны специально для локальной системы или являются компонентами более крупного приложения. Некоторые стандартные утилиты не соответствуют всем этим рекомендациям; в таких случаях разделы OPTIONS описывают отклонения.

**Рекомендация 1:**
Имена утилит должны содержать от двух до девяти символов, включая.

**Рекомендация 2:**
Имена утилит должны содержать только строчные буквы (классификация символов нижнего регистра) и цифры из переносимого набора символов.

**Рекомендация 3:**
Каждое имя опции должно быть одним алфавитно-цифровым символом (классификация символов alnum) из переносимого набора символов. Опция -W (заглавная W) должна быть зарезервирована для опций поставщика.
Многозначные опции не должны быть разрешены.

**Рекомендация 4:**
Все опции должны быть предварены символом '-' (дефис).

**Рекомендация 5:**
Одна или несколько опций без аргументов-опций, за которыми идет не более одна опция, принимающая аргумент-опцию, должны быть приняты, когда они сгруппированы за одним символом '-' (дефис).

**Рекомендация 6:**
Каждая опция и аргумент-опция должны быть отдельными аргументами, за исключением случаев, указанных в синтаксисе аргументов утилит, пункт (2).

**Рекомендация 7:**
Аргументы-опции не должны быть необязательными.

**Рекомендация 8:**
Когда для одной опции указано несколько аргументов-опций, они должны быть представлены как один аргумент, с разделителями в виде <запятой> или <пробела> внутри этого аргумента.

**Рекомендация 9:**
Все опции должны предшествовать операндам на командной строке.

**Рекомендация 10:**
Первый аргумент '--', который не является аргументом-опцией, должен быть принят как разделитель, указывающий на конец опций. Все последующие аргументы должны трактоваться как операнды, даже если они начинаются с символа '-'.

**Рекомендация 11:**
Порядок различных опций относительно друг друга не должен иметь значения, если только опции не задокументированы как взаимоисключающие и не указано, что такая опция переопределяет несовместимые опции, идущие перед ней. Если опция, имеющая аргументы-опции, повторяется, то комбинации опции и аргумента-опции должны интерпретироваться в порядке их указания на командной строке.

**Рекомендация 12:**
Порядок операндов может иметь значение, и интерпретация, зависящая от позиции, должна быть определена на основе утилиты.

**Рекомендация 13:**
Для утилит, которые используют операнды для представления файлов, которые должны быть открыты для чтения или записи, операнд '-' должен означать только стандартный ввод (или стандартный вывод, когда из контекста ясно, что указан выходной файл) или файл с именем '-'.

**Рекомендация 14:**
Если аргумент может быть идентифицирован по **Рекомендациям 3-10** как опция или как группа опций без аргументов-опций за одним символом '-', то его следует трактовать как таковой.

Утилиты в разделе Shell and Utilities объема POSIX.1-2017, которые заявляют о соответствии этим рекомендациям, должны полностью соответствовать этим рекомендациям, как если бы в этих рекомендациях использовалось слово "должны", а не "должны". В некоторых реализациях утилиты принимают использование, нарушающее эти рекомендации, для совместимости с более старыми версиями и также принимают требуемую форму.

Если утилита, описанная в разделе Shell and Utilities объема POSIX.1-2017 как соответствующая этим рекомендациям, обязана принимать или не принимать операнд '-', который означает стандартный ввод или вывод, это использование объясняется в разделе OPERANDS. В противном случае, если такая утилита использует операнды для представления файлов, то, как именно трактовать операнд '-', определяется реализацией, будь то стандартный ввод (или стандартный вывод), или файл с именем '-'.

Рекомендуется, чтобы все будущие утилиты и приложения использовали эти рекомендации для повышения переносимости пользователя. Тот факт, что некоторые исторические утилиты не могли быть изменены (чтобы избежать нарушения работы существующих приложений), не должен препятствовать этой будущей цели.
